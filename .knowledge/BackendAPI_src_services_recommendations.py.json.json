{"is_source_file": true, "format": "Python", "description": "This module implements a recommendations service for a backend music streaming API. It computes personalized track recommendations based on user listening history and popular tracks, utilizing caching for efficiency.", "external_files": ["src/db/models"], "external_methods": ["sqlalchemy.select", "sqlalchemy.func", "sqlalchemy.desc", "sqlalchemy.orm.Session"], "published": ["compute_recommendations"], "classes": [{"name": "RecommendationsCache", "description": "ORM model representing cached recommendations for users."}, {"name": "Track", "description": "ORM model representing a music track."}, {"name": "PlaybackHistory", "description": "ORM model recording user playback history."}], "methods": [{"name": "datetime _now_utc()", "description": "Returns the current UTC datetime.", "scope": "", "scopeKind": ""}, {"name": "bool _is_cache_fresh(generated_at: datetime)", "description": "Checks if the cache timestamp is within the TTL.", "scope": "", "scopeKind": ""}, {"name": "Tuple[List[int],List[str]] _fetch_recent_user_preferences(db: Session, user_id: int, recent_days: int = 30, max_seeds: int = 5)", "description": "Analyzes user's recent playback to determine top artists and genres for seed generation.", "scope": "", "scopeKind": ""}, {"name": "List[int] _fetch_popular_tracks(db: Session, limit: int = DEFAULT_RECO_LIMIT)", "description": "Retrieves globally popular tracks based on playback counts.", "scope": "", "scopeKind": ""}, {"name": "List[int] _fetch_seeded_tracks(db: Session, artist_ids: List[int], genres: List[str], limit: int = DEFAULT_RECO_LIMIT)", "description": "Fetches tracks matching user seed preferences from artists and genres.", "scope": "", "scopeKind": ""}, {"name": "List[int] _filter_existing_tracks(db: Session, track_ids: List[int])", "description": "Filters a list of track IDs to those existing in the database.", "scope": "", "scopeKind": ""}, {"name": "List[Track] compute_recommendations(db: Session, user_id: int, limit: int = DEFAULT_RECO_LIMIT, force_refresh: bool = False)", "description": "Main function to compute or retrieve cached personalized track recommendations for a user.", "scope": "", "scopeKind": ""}], "calls": ["select(Track.artist_id, func.count(PlaybackHistory.id).label('plays'))", "select(Track.genre, func.count(PlaybackHistory.id).label('plays'))", "select(PlaybackHistory.track_id, func.count(PlaybackHistory.id).label('plays'))", "select(Track.id).where(Track.artist_id.in_(artist_ids))", "select(Track.id).where(func.lower(Track.genre).in_([g.lower() for g in genres]))", "select(Track.id).where(Track.id.in_(track_ids))", "select(Track.id).order_by(desc(Track.created_at)).limit(limit)", "select(RecommendationsCache).where(RecommendationsCache.user_id == user_id)", "select(Track).where(Track.id.in_(combined))"], "search-terms": ["recommendations", "cache", "personalized", "playback history", "seed preferences", "popularity", "deduplication", "cache invalidation", "recommendation cache", "user preferences"], "state": 2, "file_id": 22, "knowledge_revision": 59, "git_revision": "94a8a1f9dff801bc25d4f2c7fb376c7cd420685b", "revision_history": [{"55": ""}, {"59": "94a8a1f9dff801bc25d4f2c7fb376c7cd420685b"}], "ctags": [{"_type": "tag", "name": "CACHE_TTL_MINUTES", "path": "/home/kavia/workspace/code-generation/music-streaming-service-21915-22055/BackendAPI/src/services/recommendations.py", "pattern": "/^CACHE_TTL_MINUTES = 60  # simple TTL; can be tuned or made configurable$/", "language": "Python", "kind": "variable"}, {"_type": "tag", "name": "DEFAULT_RECO_LIMIT", "path": "/home/kavia/workspace/code-generation/music-streaming-service-21915-22055/BackendAPI/src/services/recommendations.py", "pattern": "/^DEFAULT_RECO_LIMIT = 25$/", "language": "Python", "kind": "variable"}, {"_type": "tag", "name": "_fetch_popular_tracks", "path": "/home/kavia/workspace/code-generation/music-streaming-service-21915-22055/BackendAPI/src/services/recommendations.py", "pattern": "/^def _fetch_popular_tracks(db: Session, limit: int = DEFAULT_RECO_LIMIT) -> List[int]:$/", "language": "Python", "typeref": "typename:List[int]", "kind": "function", "signature": "(db: Session, limit: int = DEFAULT_RECO_LIMIT)"}, {"_type": "tag", "name": "_fetch_recent_user_preferences", "path": "/home/kavia/workspace/code-generation/music-streaming-service-21915-22055/BackendAPI/src/services/recommendations.py", "pattern": "/^def _fetch_recent_user_preferences(db: Session, user_id: int, recent_days: int = 30, max_seeds: /", "language": "Python", "typeref": "typename:Tuple[List[int],List[str]]", "kind": "function", "signature": "(db: Session, user_id: int, recent_days: int = 30, max_seeds: int = 5)"}, {"_type": "tag", "name": "_fetch_seeded_tracks", "path": "/home/kavia/workspace/code-generation/music-streaming-service-21915-22055/BackendAPI/src/services/recommendations.py", "pattern": "/^def _fetch_seeded_tracks(db: Session, artist_ids: List[int], genres: List[str], limit: int = DEF/", "language": "Python", "typeref": "typename:List[int]", "kind": "function", "signature": "(db: Session, artist_ids: List[int], genres: List[str], limit: int = DEFAULT_RECO_LIMIT)"}, {"_type": "tag", "name": "_filter_existing_tracks", "path": "/home/kavia/workspace/code-generation/music-streaming-service-21915-22055/BackendAPI/src/services/recommendations.py", "pattern": "/^def _filter_existing_tracks(db: Session, track_ids: List[int]) -> List[int]:$/", "language": "Python", "typeref": "typename:List[int]", "kind": "function", "signature": "(db: Session, track_ids: List[int])"}, {"_type": "tag", "name": "_is_cache_fresh", "path": "/home/kavia/workspace/code-generation/music-streaming-service-21915-22055/BackendAPI/src/services/recommendations.py", "pattern": "/^def _is_cache_fresh(generated_at: datetime) -> bool:$/", "language": "Python", "typeref": "typename:bool", "kind": "function", "signature": "(generated_at: datetime)"}, {"_type": "tag", "name": "_now_utc", "path": "/home/kavia/workspace/code-generation/music-streaming-service-21915-22055/BackendAPI/src/services/recommendations.py", "pattern": "/^def _now_utc() -> datetime:$/", "language": "Python", "typeref": "typename:datetime", "kind": "function", "signature": "()"}, {"_type": "tag", "name": "compute_recommendations", "path": "/home/kavia/workspace/code-generation/music-streaming-service-21915-22055/BackendAPI/src/services/recommendations.py", "pattern": "/^def compute_recommendations(db: Session, user_id: int, limit: int = DEFAULT_RECO_LIMIT, force_re/", "language": "Python", "typeref": "typename:List[Track]", "kind": "function", "signature": "(db: Session, user_id: int, limit: int = DEFAULT_RECO_LIMIT, force_refresh: bool = False)"}], "hash": "e1bfe9fbbdd2f9c9f9537d4383d63550", "format-version": 4, "code-base-name": "BackendAPI", "filename": "BackendAPI/src/services/recommendations.py", "fields": [{"name": "CACHE_TTL_MINUTES = 60  # simple TTL; can be tuned or made configurable", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "DEFAULT_RECO_LIMIT = 25", "scope": "", "scopeKind": "", "description": "unavailable"}]}